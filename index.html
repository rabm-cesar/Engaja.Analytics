<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard: Engaja Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #edf6ff; /* Branco azulado */
        }
        .bg-custom-dark {
            background-color: #12161a; /* Preto quase puro */
        }
        .text-azul-claro { color: #79a6f6; }
        .text-ciano { color: #3aced8; }
        .text-rosa { color: #f97bb2; }
        .bg-azul-intenso { background-color: #0042cd; }
        .bg-azul-marinho { background-color: #072f94; }
        .ring-azul-vibrante { ring-color: #146df9; }

        /* Estilos para a barra de scroll */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #12161a;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #072f94;
            border-radius: 10px;
            border: 2px solid #12161a;
        }
        .modal {
            display: none;
            transition: opacity 0.3s ease;
        }
        .modal.open {
            display: flex;
        }
        .spinner {
            border-top-color: #3aced8;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">
    <div class="bg-custom-dark p-4 sm:p-6 md:p-8 rounded-2xl shadow-2xl text-center w-full max-w-7xl mx-4 my-8 h-[90vh] flex flex-col">
        
        <!-- Cabeçalho -->
        <header class="flex flex-col sm:flex-row items-center justify-between mb-6 pb-4 border-b border-gray-700">
            <div class="flex items-center">
                <div class="w-16 h-auto">
                    <svg viewBox="0 0 120 85" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="gaugeGradientFinal" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#f97bb2;" />
                                <stop offset="50%" style="stop-color:#3aced8;" />
                                <stop offset="100%" style="stop-color:#79a6f6;" />
                            </linearGradient>
                        </defs>
                        <path d="M 10 70 A 50 50, 0, 0, 1, 110 70" fill="none" stroke="url(#gaugeGradientFinal)" stroke-width="14" stroke-linecap="round"/>
                        <g fill="#edf6ff">
                            <circle cx="60" cy="45" r="7"></circle>
                            <path d="M 60 54 L 52 70 L 68 70 Z"></path>
                        </g>
                        <g transform="rotate(45 60 70)">
                            <path d="M 60 70 L 60 25" stroke="#edf6ff" stroke-width="4" stroke-linecap="round"></path>
                            <circle cx="60" cy="70" r="6" fill="#edf6ff"></circle>
                        </g>
                    </svg>
                </div>
                <div class="text-left ml-4">
                    <h1 class="text-2xl md:text-3xl">
                        <span class="font-bold text-azul-claro">Engaja</span>
                        <span class="font-light text-white">Analytics</span>
                    </h1>
                    <p class="text-gray-400 text-xs md:text-sm">Monitorando o engajamento, impulsionando o futuro.</p>
                </div>
            </div>
            <div class="mt-4 sm:mt-0">
                <h2 class="text-white text-lg font-semibold">Painel de Risco de Turnover</h2>
            </div>
        </header>

        <!-- Corpo do Dashboard -->
        <main class="flex-grow overflow-y-auto">
            <div class="grid grid-cols-1 gap-4">
                <!-- Tabela de Colaboradores -->
                <div class="bg-gray-900/50 p-4 rounded-lg">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-300">
                            <thead class="text-xs text-azul-claro uppercase bg-gray-800">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Colaborador</th>
                                    <th scope="col" class="px-6 py-3">Departamento</th>
                                    <th scope="col" class="px-6 py-3 text-center">Nível de Risco</th>
                                    <th scope="col" class="px-6 py-3 text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="employee-table-body">
                                <!-- Linhas da tabela serão inseridas aqui via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal para Detalhes e Ações de IA -->
    <div id="employee-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4">
        <div class="bg-custom-dark rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col ring-2 ring-azul-vibrante">
            <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-bold text-white" id="modal-employee-name"></h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div class="p-6 flex-grow overflow-y-auto">
                <div id="employee-details" class="text-gray-300 mb-4"></div>
                <button id="generate-plan-btn" class="w-full bg-azul-intenso hover:bg-azul-marinho text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center transition-colors">
                    <span class="mr-2">✨</span> Gerar Plano de Ação com IA
                </button>
                <div id="ai-plan-container" class="mt-4 text-left hidden">
                    <div class="flex justify-between items-center">
                        <h4 class="text-lg font-semibold text-azul-claro mb-2">Plano de Ação Sugerido</h4>
                        <button id="play-audio-btn" class="bg-ciano/20 text-ciano p-2 rounded-full hover:bg-ciano/40 disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" /></svg>
                        </button>
                    </div>
                    <div id="ai-plan-content" class="bg-gray-900/50 p-4 rounded-lg whitespace-pre-wrap text-gray-300"></div>
                </div>
                 <div id="loading-spinner" class="mt-4 hidden text-center">
                    <div class="spinner h-8 w-8 border-4 border-gray-700 rounded-full mx-auto"></div>
                    <p class="text-ciano mt-2">A IA está a gerar um plano personalizado...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DADOS SIMULADOS (Baseado na estrutura do CSV) ---
        const employees = [
            { id: 1, name: 'Ana Silva', department: 'Vendas', satisfaction: 0.38, evaluation: 0.53, projects: 2, hours: 157, tenure: 3, promotion: 0, risk: 'Alto' },
            { id: 2, name: 'Bruno Costa', department: 'Técnico', satisfaction: 0.80, evaluation: 0.86, projects: 5, hours: 262, tenure: 6, promotion: 0, risk: 'Baixo' },
            { id: 3, name: 'Carla Dias', department: 'Vendas', satisfaction: 0.11, evaluation: 0.88, projects: 7, hours: 272, tenure: 4, promotion: 0, risk: 'Alto' },
            { id: 4, name: 'Diogo Martins', department: 'Suporte', satisfaction: 0.72, evaluation: 0.87, projects: 5, hours: 223, tenure: 5, promotion: 0, risk: 'Médio' },
            { id: 5, name: 'Eva Rocha', department: 'RH', satisfaction: 0.59, evaluation: 0.92, projects: 3, hours: 142, tenure: 3, promotion: 1, risk: 'Baixo' },
            { id: 6, name: 'Fábio Neves', department: 'Marketing', satisfaction: 0.41, evaluation: 0.50, projects: 2, hours: 153, tenure: 3, promotion: 0, risk: 'Alto' },
            { id: 7, name: 'Sofia Pereira', department: 'Técnico', satisfaction: 0.10, evaluation: 0.77, projects: 6, hours: 247, tenure: 4, promotion: 0, risk: 'Alto' },
            { id: 8, name: 'Hugo Almeida', department: 'Desenvolvimento', satisfaction: 0.92, evaluation: 0.85, projects: 5, hours: 259, tenure: 5, promotion: 0, risk: 'Baixo' },
            { id: 9, name: 'Inês Gomes', department: 'Contabilidade', satisfaction: 0.42, evaluation: 0.53, projects: 2, hours: 142, tenure: 3, promotion: 0, risk: 'Médio' },
            { id: 10, name: 'João Ribeiro', department: 'Vendas', satisfaction: 0.78, evaluation: 0.99, projects: 4, hours: 255, tenure: 6, promotion: 0, risk: 'Médio' },
        ];

        // --- ELEMENTOS DO DOM ---
        const tableBody = document.getElementById('employee-table-body');
        const modal = document.getElementById('employee-modal');
        const modalEmployeeName = document.getElementById('modal-employee-name');
        const employeeDetails = document.getElementById('employee-details');
        const generatePlanBtn = document.getElementById('generate-plan-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const aiPlanContainer = document.getElementById('ai-plan-container');
        const aiPlanContent = document.getElementById('ai-plan-content');
        const loadingSpinner = document.getElementById('loading-spinner');
        const playAudioBtn = document.getElementById('play-audio-btn');

        let currentEmployeeData = null;
        let generatedPlanText = '';

        // --- FUNÇÕES DE RENDERIZAÇÃO ---
        function getRiskBadge(risk) {
            switch (risk) {
                case 'Alto': return 'bg-red-500/20 text-red-400';
                case 'Médio': return 'bg-yellow-500/20 text-yellow-400';
                case 'Baixo': return 'bg-green-500/20 text-green-400';
                default: return 'bg-gray-500/20 text-gray-400';
            }
        }

        function populateTable() {
            tableBody.innerHTML = '';
            employees.forEach(emp => {
                const row = document.createElement('tr');
                row.className = 'bg-gray-900 border-b border-gray-800 hover:bg-gray-800/50';
                row.innerHTML = `
                    <td class="px-6 py-4 font-medium text-white whitespace-nowrap">${emp.name}</td>
                    <td class="px-6 py-4">${emp.department}</td>
                    <td class="px-6 py-4 text-center">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${getRiskBadge(emp.risk)}">${emp.risk}</span>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <button data-id="${emp.id}" class="view-details-btn font-medium text-azul-claro hover:underline">Ver Detalhes</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // --- FUNÇÕES DO MODAL ---
        function openModal(employee) {
            currentEmployeeData = employee;
            generatedPlanText = '';
            modalEmployeeName.textContent = `Plano de Retenção: ${employee.name}`;
            employeeDetails.innerHTML = `
                <p><strong>Departamento:</strong> ${employee.department}</p>
                <p><strong>Nível de Satisfação:</strong> ${employee.satisfaction}</p>
                <p><strong>Última Avaliação:</strong> ${employee.evaluation}</p>
                <p><strong>Projetos Atuais:</strong> ${employee.projects}</p>
                <p><strong>Média de Horas/Mês:</strong> ${employee.hours}</p>
                <p><strong>Tempo de Empresa:</strong> ${employee.tenure} anos</p>
                <p><strong>Promoção (5 anos):</strong> ${employee.promotion ? 'Sim' : 'Não'}</p>
            `;
            generatePlanBtn.disabled = employee.risk !== 'Alto';
            generatePlanBtn.style.opacity = employee.risk !== 'Alto' ? 0.5 : 1;
            generatePlanBtn.style.cursor = employee.risk !== 'Alto' ? 'not-allowed' : 'pointer';
            
            aiPlanContainer.classList.add('hidden');
            aiPlanContent.textContent = '';
            loadingSpinner.classList.add('hidden');
            playAudioBtn.disabled = true;

            modal.classList.add('open');
        }

        function closeModal() {
            modal.classList.remove('open');
        }

        // --- LÓGICA DA API GEMINI ---
        
        // Função para chamar a API com retentativa exponencial
        async function fetchWithBackoff(apiUrl, payload, maxRetries = 5) {
            let delay = 1000; // 1 segundo
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return await response.json();
                    } else if (response.status === 429 || response.status >= 500) {
                        // Throttling ou erro de servidor, espera e tenta de novo
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Aumenta o tempo de espera
                    } else {
                        // Outros erros (e.g., 400), não tenta de novo
                        console.error('Erro na API:', response.statusText);
                        return null;
                    }
                } catch (error) {
                    console.error('Erro de rede:', error);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
            return null; // Retorna null se todas as tentativas falharem
        }

        async function handleGeneratePlan() {
            if (!currentEmployeeData) return;

            loadingSpinner.classList.remove('hidden');
            aiPlanContainer.classList.add('hidden');
            generatePlanBtn.disabled = true;

            const prompt = `Aja como um especialista em Recursos Humanos. Um colaborador chamado ${currentEmployeeData.name} do departamento de ${currentEmployeeData.department} está em alto risco de turnover. 
            Os seus dados são:
            - Nível de Satisfação: ${currentEmployeeData.satisfaction} (escala de 0 a 1)
            - Última Avaliação: ${currentEmployeeData.evaluation} (escala de 0 a 1)
            - Média de Horas Mensais: ${currentEmployeeData.hours}
            - Tempo de Empresa: ${currentEmployeeData.tenure} anos
            - Promoção nos últimos 5 anos: ${currentEmployeeData.promotion ? 'Sim' : 'Não'}

            Com base nestes dados, crie um plano de ação conciso e prático para o gestor deste colaborador. O plano deve ser dividido em três secções com títulos em negrito: '**Pontos de Conversa**', '**Possíveis Soluções**' e '**Oportunidades de Desenvolvimento**'. Use uma linguagem positiva e focada em soluções.`;

            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const result = await fetchWithBackoff(apiUrl, payload);

            loadingSpinner.classList.add('hidden');
            generatePlanBtn.disabled = false;

            if (result && result.candidates && result.candidates.length > 0) {
                generatedPlanText = result.candidates[0].content.parts[0].text;
                aiPlanContent.textContent = generatedPlanText;
                aiPlanContainer.classList.remove('hidden');
                playAudioBtn.disabled = false;
            } else {
                aiPlanContent.textContent = 'Não foi possível gerar um plano de ação. Por favor, tente novamente.';
                aiPlanContainer.classList.remove('hidden');
            }
        }

        // --- LÓGICA DA API TTS ---
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1;
            const bitsPerSample = 16;
            const byteRate = sampleRate * numChannels * (bitsPerSample / 8);
            const blockAlign = numChannels * (bitsPerSample / 8);
            const dataSize = pcmData.length * (bitsPerSample / 8);
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            // RIFF header
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataSize, true);
            writeString(view, 8, 'WAVE');
            // fmt chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);
            // data chunk
            writeString(view, 36, 'data');
            view.setUint32(40, dataSize, true);

            // Write PCM data
            let offset = 44;
            for (let i = 0; i < pcmData.length; i++, offset += 2) {
                view.setInt16(offset, pcmData[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }
        
        async function handlePlayAudio() {
            if (!generatedPlanText) return;
            playAudioBtn.disabled = true;
            
            const payload = {
                contents: [{ parts: [{ text: `Leia o seguinte plano de ação de forma clara e profissional: ${generatedPlanText}` }] }],
                generationConfig: { responseModalities: ["AUDIO"] },
                model: "gemini-2.5-flash-preview-tts"
            };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            const result = await fetchWithBackoff(apiUrl, payload);

            if (result && result.candidates && result.candidates.length > 0) {
                const audioData = result.candidates[0].content.parts[0].inlineData.data;
                const mimeType = result.candidates[0].content.parts[0].inlineData.mimeType;
                
                if (audioData && mimeType.startsWith("audio/")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;
                    
                    const pcmBuffer = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmBuffer);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    const audio = new Audio(audioUrl);
                    audio.play();
                    audio.onended = () => { playAudioBtn.disabled = false; };
                }
            } else {
                alert('Não foi possível gerar o áudio.');
                playAudioBtn.disabled = false;
            }
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            populateTable();
            document.querySelectorAll('.view-details-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const employeeId = parseInt(e.target.dataset.id);
                    const employee = employees.find(emp => emp.id === employeeId);
                    openModal(employee);
                });
            });
        });

        closeModalBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });
        generatePlanBtn.addEventListener('click', handleGeneratePlan);
        playAudioBtn.addEventListener('click', handlePlayAudio);

    </script>
</body>
</html>
